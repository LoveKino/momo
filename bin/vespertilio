#!/usr/bin/env node

const yargs = require('yargs');
const {deployDpm, getVespertilioConf, build} = require('../src');

yargs.usage(`Usage: vespertilio build | deploy | run
    --upd
    --config    config file path
    --only      only build one worker
    `).help('h').alias('h', 'help');

const {argv} = yargs;

const run = async () => {
  const cnf = await getVespertilioConf(argv);
  const cmd = argv._[0];
  switch(cmd) {
    case 'build':
      await build(cnf, argv);
      break;
    case 'deploy':
      await deployDpm(cnf.dpm['deploy-cnf'], 'staging');
      break;
    case 'run':
      await build(cnf, argv);
      await deployDpm(cnf.dpm['deploy-cnf'], 'staging');
      break;
    default:
      throw new Error(`unexpected command: ${cmd}`);
  }
};

run();
